---
title: "Daynight-Q10"
author: "Colin Wu"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cosore)
library(dplyr)
library(lubridate)
db_info <- csr_database()
results <- list()
```

## Goal 1
```{r goal1, eval=TRUE, echo=FALSE}
rh_dataset_names <- db_info[grep("Rh", db_info$CSR_MSMT_VAR),1][[1]]
for(rhds in rh_dataset_names){
  print(rhds)
}
```

<!--
```{r new-goal1}
rh_dataset_names <- filter(db_info, grepl("Rh", CSR_MSMT_VAR))
rh_dataset_names <- pull(rh_dataset_names, CSR_DATASET)
print(rh_dataset_names)
```
-->

## Goal 2
```{r Goal 2, message = FALSE}
results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  ports_table <- ds_data$ports
  Rh_ports <- filter(ports_table, CSR_MSMT_VAR == "Rh")
  results[[rhds]] <- Rh_ports
}

final_results <- bind_rows(results, .id = "Dataset")
print(final_results)
```

## calc_q10 Function
```{r Q10 Function}
calc_q10 <- function(temp, resp){
  positives <- resp > 0 & !is.na(temp) & !is.na(resp)
  resp <- resp[positives]
  temp <- temp[positives]
  if(length(resp) < 4){
    return(NA)
  }
  lnresp <- log(resp)
  linReg <- lm(lnresp~temp)
  b <- linReg$coefficients[["temp"]]
  q10 <- exp(10*b)
  return(q10)
}

```
```{r Q10 Function Test}
set.seed(2020)
x <- 1:20
y <- 2 ^ (x/10) + rnorm(length(x), sd = .3)
plot(x,y)
cat("The Q10 Value is", calc_q10(x,y))
```

## Ts Percentage
```{r Ts Percentage, message = FALSE, warning=FALSE, eval = FALSE}
main_results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  dsd <- ds_data$data
  column_names <- names(dsd)
  temperature_columns <- column_names[grep("^CSR_T(AIR|[0-9]+)", column_names)]
  results <- data.frame(columns = temperature_columns, depth = NA, q10 = NA, n = NA)
  resp <- dsd$CSR_FLUX_CO2
  for(tcol in temperature_columns){
    temp <- dsd[[tcol]]
    results$q10[results$columns == tcol] = calc_q10(temp, resp)
    results$n[results$columns == tcol] = length(temp[!is.na(temp) & !is.na(resp)])
    depth <- gsub("^CSR_T", "", tcol)
    #Check to see if depth is a number, if it isn't (if it's AIR) then depth is set to -1
    if(!is.na(as.numeric(depth))){
      depth <- as.numeric(depth)
    }else{
      depth <- -1
    }
    results$depth[results$columns == tcol] = depth
  }
  main_results[[rhds]] <- results
}
main_results <- bind_rows(main_results, .id = "Dataset")
print(main_results)
```

## Q10 By Week
```{r 1 variable Q10 function}
csr_q10 <- function(temp){
  positives <- resp > 0 & !is.na(temp) & !is.na(resp)
  resp <- resp[positives]
  temp <- temp[positives]
  if(length(CSR_FLUX_CO2) < 4){
    return(NA)
  }
  lnresp <- log(CSR_FLUX_CO2)
  linReg <- lm(lnresp~temp)
  b <- linReg$coefficients[["temp"]]
  q10 <- exp(10*b)
  return(q10)
}

```

```{r by week, message=FALSE, warning=FALSE}
week_Q10 <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  dsd <- ds_data$data
  
  column_names <- names(dsd)
  temperature_columns <- column_names[grep("^CSR_T(AIR|[0-9]+)", column_names)]
  rh_ports <- final_results[final_results$Dataset == rhds, ][[2]]
  
  dsd %>% filter(CSR_PORT %in% rh_ports & !is.na(CSR_FLUX_CO2)) %>% mutate(WOY = week(CSR_TIMESTAMP_END), YEAR = year(CSR_TIMESTAMP_END)) -> dsd
  
  dsd %>% select(WOY, YEAR) %>% unique() -> num_weeks
  
  for(tcol in temperature_columns){
    dsd$temp <- dsd[[tcol]]
    depth <- gsub("^CSR_T", "", tcol)
    #Check to see if depth is a number, if it isn't (if it's AIR) then depth is set to -1
    if(!is.na(as.numeric(depth))){
      depth <- as.numeric(depth)
    }else{
      depth <- -1
    }
    depth <- toString(depth)
    dsd %>% group_by(YEAR, WOY) %>% summarize(DATASET = rhds, Q10 = calc_q10(temp, CSR_FLUX_CO2), TEMP = mean(temp, na.rm=TRUE), RESP = mean(CSR_FLUX_CO2)) %>% filter(!is.na(Q10))-> week_Q10[[depth]]
  }
}
week_Q10 <- bind_rows(week_Q10, .id = "Depth")
week_Q10 <- week_Q10[, c(4, 1:3, 5:7)]
print(week_Q10, n = 100)
```

