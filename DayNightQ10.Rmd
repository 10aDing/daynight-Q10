---
title: "Daynight-Q10"
author: "Colin Wu"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(cosore)
library(dplyr)
db_info <- csr_database()
results <- list()
```

## Goal 1
```{r goal1, eval=TRUE, echo=FALSE}
rh_dataset_names <- db_info[grep("Rh", db_info$CSR_MSMT_VAR),1][[1]]
for(rhds in rh_dataset_names){
  print(rhds)
}
```

<!--
```{r new-goal1}
rh_dataset_names <- filter(db_info, grepl("Rh", CSR_MSMT_VAR))
rh_dataset_names <- pull(rh_dataset_names, CSR_DATASET)
print(rh_dataset_names)
```
-->

## Goal 2
```{r Goal 2}
results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  ports_table <- ds_data$ports
  Rh_ports <- filter(ports_table, CSR_MSMT_VAR == "Rh")
  results[[rhds]] <- Rh_ports
}

final_results <- bind_rows(results, .id = "Dataset")
print(final_results)
```

## calc_q10 Function
```{r Q10 Function}
calc_q10 <- function(temp, resp){
  positives <- resp > 0 & !is.na(temp) & !is.na(resp)
  resp <- resp[positives]
  temp <- temp[positives]
  lnresp <- log(resp)
  linReg <- lm(lnresp~temp)
  b <- linReg$coefficients[["temp"]]
  q10 <- exp(10*b)
  return(q10)
}

```
```{r Q10 Function Test}
set.seed(2020)
x <- 1:20
y <- 2 ^ (x/10) + rnorm(length(x), sd = .3)
plot(x,y)
cat("The Q10 Value is", calc_q10(x,y))
```

## Ts Percentage
```{r Ts Percentage}
main_results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  dsd <- ds_data$data
  column_names <- names(dsd)
  temperature_columns <- column_names[grep("^CSR_T(AIR|[0-9]+)", column_names)]
  results <- data.frame(columns = temperature_columns, depth = NA, q10 = NA, n = NA)
  for(tcol in temperature_columns){
    print(calc_q10(dsd[[tcol]], dsd$CSR_FLUX_CO2))
  }
}

```
