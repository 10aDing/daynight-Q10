---
title: "Daynight-Q10"
author: "Colin Wu"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(suncalc)
library(raster)
#library(StreamMetabolism)
#library(NISTunits)

#Download worldclim data for precip and tmean if necessary, into w10/ folder
precip <- getData("worldclim", path = here::here(), var = "prec", res = 10, download = !file.exists("wc10/prec1.hdr"))
tmean <- getData("worldclim", path = here::here(), var = "tmean", res = 10, download = !file.exists("wc10/tmean1.hdr"))
bio <- getData("worldclim", path = here::here(), var = "bio", res = 10, download = !file.exists("wc10/bio.hdr"))[[c(1,12)]]

library(cosore)
db_info <- csr_database()
results <- list()
```

## Goal 1
```{r goal1, eval=TRUE, echo=FALSE}
rh_dataset_names <- db_info[grep("Rh", db_info$CSR_MSMT_VAR),1][[1]]
for(rhds in rh_dataset_names){
  print(rhds)
}
```

<!--
```{r new-goal1}
rh_dataset_names <- filter(db_info, grepl("Rh", CSR_MSMT_VAR))
rh_dataset_names <- pull(rh_dataset_names, CSR_DATASET)
print(rh_dataset_names)
```
-->

## Goal 2
```{r Goal 2, message = FALSE}
results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  ports_table <- ds_data$ports
  Rh_ports <- filter(ports_table, CSR_MSMT_VAR == "Rh")
  results[[rhds]] <- Rh_ports
}

final_results <- bind_rows(results, .id = "Dataset")
print(final_results)
```

## calc_q10 Function
```{r p-value function from https://gettinggeneticsdone.blogspot.com/2011/01/rstats-function-for-extracting-f-test-p.html}
lmp <- function (modelobject) {
	if (class(modelobject) != "lm") stop("Not an object of class 'lm' ")
	f <- summary(modelobject)$fstatistic
	p <- pf(f[1],f[2],f[3],lower.tail=F)
	attributes(p) <- NULL
	return(p)
}
```

```{r Q10 Function}
calc_q10 <- function(temp, resp){
  positives <- resp > 0 & !is.na(temp) & !is.na(resp)
  resp <- resp[positives]
  temp <- temp[positives]
  if(length(resp) < 4){
    return(NA)
  }
  lnresp <- log(resp)
  linReg <- lm(lnresp~temp)
  sumReg <- summary(linReg)
  b <- linReg$coefficients[["temp"]]
  q10 <- exp(10*b)
  r_squared = NA
  p_val = NA
  if(!is.infinite(q10) & !is.na(q10)){
    r_squared <- sumReg$r.squared
    p_val <- lmp(linReg)
  }
  return_val <- data.frame(Q10 = q10, R2 = r_squared, P_VALUE = p_val)
  return(return_val)
}
```

```{r Q10 Function Test}
set.seed(2020)
x <- 1:20
y <- 2 ^ (x/10) + rnorm(length(x), sd = .3)
plot(x,y)
cat("The Q10 Value is", calc_q10(x,y)[,1])
```

## Ts Percentage
```{r Ts Percentage, message = FALSE, warning=FALSE}
main_results <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  dsd <- ds_data$data
  column_names <- names(dsd)
  temperature_columns <- column_names[grep("^CSR_T(AIR|[0-9]+)", column_names)]
  results <- data.frame(columns = temperature_columns, depth = NA, q10 = NA, n = NA)
  resp <- dsd$CSR_FLUX_CO2
  for(tcol in temperature_columns){
    temp <- dsd[[tcol]]
    results$q10[results$columns == tcol] = calc_q10(temp, resp)[,1]
    results$n[results$columns == tcol] = length(temp[!is.na(temp) & !is.na(resp)])
    depth <- gsub("^CSR_T", "", tcol)
    #Check to see if depth is a number, if it isn't (if it's AIR) then depth is set to -1
    if(!is.na(as.numeric(depth))){
      depth <- as.numeric(depth)
    }else{
      depth <- -1
    }
    results$depth[results$columns == tcol] = depth
  }
  main_results[[rhds]] <- results
}
main_results <- bind_rows(main_results, .id = "Dataset")
print(main_results)
```

## Q10 By Week and Day/Night
```{r by week, message=FALSE, warning=FALSE, cache = FALSE}
week_Q10 <- list()
MA_set <- list()
for(rhds in rh_dataset_names){
  ds_data <- csr_dataset(rhds)
  dsd <- ds_data$data
  ds_desc <- ds_data$description
  ds_ports <- ds_data$ports
  
  column_names <- names(dsd)
  temperature_columns <- column_names[grep("^CSR_T(AIR|[0-9]+)", column_names)]
  rh_ports <- final_results[final_results$Dataset == rhds, ][[2]]
  rs_ports <- ds_ports[ds_ports$CSR_MSMT_VAR == "Rs",][[1]]
  
  date <- as.Date(dsd$CSR_TIMESTAMP_END)
  lon <- ds_desc$CSR_LONGITUDE
  lat <- ds_desc$CSR_LATITUDE
  timezone <- attr(dsd$CSR_TIMESTAMP_END, "tzone")
  
  sunrise_set <- getSunlightTimes(date, lat, lon, keep = c("sunrise", "sunset"), tz = timezone)
  #sunrise_set <- sunrise.set(lat, lon, date)
  sunrise <- sunrise_set[["sunrise"]]
  sunset <- sunrise_set[["sunset"]]
  
  MA_row <- data.frame(LON = lon, LAT = lat)
  # MAP data that matches the srdb coordinates
  raster::extract(precip, MA_row[1:2]) -> precip_coords
  apply(precip_coords, 1, sum) -> MA_row$MAP
  
  # The same for MAT
  raster::extract(tmean, MA_row[1:2]) -> tmean_vals
  apply(tmean_vals, 1, mean)/10 -> MA_row$MAT
  
  MA_row <- cbind.data.frame(MA_row, raster::extract(bio, MA_row[1:2]))
  MA_set[[rhds]] <- MA_row
  
  dsd %>% 
    mutate(DAY_NIGHT = case_when(
      sunrise < CSR_TIMESTAMP_BEGIN & CSR_TIMESTAMP_BEGIN < sunset ~ "day",
      TRUE ~ "night"), 
      Rs_Rh = case_when(
        CSR_PORT %in% rh_ports ~ "Rh", 
        CSR_PORT %in% rs_ports ~ "Rs",
        TRUE ~ "other")) %>%
    filter(!is.na(CSR_FLUX_CO2), CSR_FLUX_CO2 > 0, Rs_Rh != "other") %>%
    mutate(WOY = week(CSR_TIMESTAMP_END),
           MONTH = month(CSR_TIMESTAMP_END),
           YEAR = year(CSR_TIMESTAMP_END),
           DAY_NIGHT = factor(DAY_NIGHT),
           Rs_Rh = factor(Rs_Rh)) ->
    dsd
  
  for(tcol in temperature_columns){
    dsd$temp <- dsd[[tcol]]
    depth <- gsub("^CSR_T", "", tcol)
    # Check to see if depth is a number, if it isn't (if it's AIR) then depth is set to -1
    if(!is.na(as.numeric(depth))){
      depth <- as.numeric(depth)
    } else {
      depth <- -1
    }
    dsd %>% 
      group_by(YEAR, MONTH, DAY_NIGHT, Rs_Rh) %>% 
      summarize(DATASET = rhds, 
                DEPTH = depth, 
                Q10 = calc_q10(temp, CSR_FLUX_CO2),
                TEMP = mean(temp, na.rm=TRUE), 
                RESP = mean(CSR_FLUX_CO2, na.rm = TRUE),
                N = n()) %>% 
      unpack(cols = Q10) -> 
      week_Q10[[paste(rhds, depth, sep="_")]]
  }
}
bind_rows(week_Q10, .id = "ID") %>% 
  filter(!is.na(Q10), is.finite(Q10)) %>% 
  dplyr::select(DATASET, YEAR:MONTH, DAY_NIGHT, Rs_Rh, DEPTH:RESP, N) %>% 
  arrange(DATASET, DEPTH, YEAR, MONTH) -> 
  week_Q10

MA_set <- bind_rows(MA_set, .id = "DATASET")

print(week_Q10)
summary(week_Q10)
print(MA_set)
```

## Sunset/Sunrise Calculation Test
```{r, eval=FALSE}
#daytime <- function(lat, long, doy){
#  lat <- NISTdegTOradian(lat)
#  long <- NISTdegTOradian(long)
#  frac_yr = 2 * pi/365 * (doy - 1 + (hr-12)/24)
#  eqtime = 229.18*(0.000075+0.001868*cos(frac_yr)-0.032077*sin(frac_yr)-0.014615*cos(2*frac_yr)-0.040849*sin(2*frac_yr))
#  decl =  0.006918-0.399912*cos(frac_yr)+0.070257*sin(frac_yr)-0.006758*cos(2*frac_yr)+0.000907*sin(2*frac_yr)-0.002697*cos(3*frac_yr)+0.00148*sin(3*frac_yr)
#  ha = acos(cos(NISTdegTOradian(90.833))/(cos(lat)*cos(decl))-tan(lat)*tan(decl))
#  sunrise=720-4*(long+ha)-eqtime
#  sunset=720-4*(long-ha)-eqtime
#}
lat <- 39.110940
lon <- -77.171990
date <- "2020/07/29"
date2 <- as.Date(date)
timez = Sys.timezone()
sunrise_set = sunrise.set(lat, lon, date2 + 1, timezone=timez)
print(sunrise_set)
sunset_rise = getSunlightTimes(date2, lat, lon, keep = c("sunrise", "sunset"), tz = timez)
print(sunset_rise)
print(sunset_rise[["sunrise"]])
print(sunset_rise[["sunset"]])
print(sunrise_set)
sunrise = sunrise_set[[1]]
sunset = sunrise_set[[2]]
class(sunrise)
print(sunrise < sunset)
format(sunrise)
```

## Graphing Results
```{r, fig.height=6, eval = FALSE}
p <- ggplot(week_Q10, aes(WOY, Q10, color = DAY_NIGHT, group = paste(YEAR, DAY_NIGHT))) + 
  geom_line(na.rm = TRUE) +
  ylim(c(0, 5)) + 
  facet_wrap(~ID+DEPTH)
print(p)
```
```{r, message=FALSE, warning=FALSE}
a <- ggplot(week_Q10, aes(x = R2)) + geom_histogram(color= "black", fill = "white")
a2 <- ggplot(week_Q10, aes(x = Q10)) + geom_histogram(color= "black", fill = "white") + xlim(0, 5)
b <- ggplot(week_Q10, aes(x = R2, fill=DAY_NIGHT)) + geom_histogram() + facet_wrap(~DATASET)
c <- ggplot(week_Q10, aes(x = Q10, fill=DAY_NIGHT)) + geom_histogram() + xlim(0, 5) + facet_wrap(~DATASET)
d <- ggplot(week_Q10, aes(x = MONTH, y = DATASET, fill = Q10)) + geom_tile() + lims(fill = c(0, 5))
d2 <- ggplot(week_Q10, aes(x = MONTH, y = YEAR, fill = Q10)) + geom_tile() + lims(fill = c(0, 5))
print(a)
print(a2)
print(b)
print(c)
print(d)
print(d2)
print(ggplot(week_Q10, aes(MONTH, Q10, color = DAY_NIGHT, group = paste(YEAR, DAY_NIGHT))) + geom_line() + ylim(0,5) + facet_wrap(~DATASET+DEPTH+Rs_Rh))
```
